---
  name: e-commerce workflow 
  on:
    push:
      branches:
        - main

  jobs:
    unit-testing:
      name: Unit Testing
      runs-on: ubuntu-latest
      container: node:18
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v4

        - name: Cache NPM dependencies
          uses: actions/cache@v4
          with:
            path: ~/.npm
            key: '${{ runner.os }}-node-modules-${{ hashFiles(''package-lock.json'') }}'


        - name: Install Dependencies
          run: npm install

    docker:
      name: docker-build
      needs: unit-testing
      runs-on: ubuntu-latest
      steps:
        - name: checkout repo
          uses: actions/checkout@v4.2.2

        - name: DockerLogin
          uses: docker/login-action@v3.4.0
          with:
            username: ${{ vars.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build and push Docker images
          uses: docker/build-push-action@v6.18.0
          with:
            push: true
            tags: ${{ vars.IMAGE_NAME }}:${{ github.run_id }}
            context: .

    k8s:
      name: k8s-image-update
      needs: docker
      runs-on: ubuntu-latest
      steps:
        - name: checkout repo
          uses: actions/checkout@v4.2.2 

        - name: Set up Git
          run: |
            git config --global user.name "github-ubuntu"
            git config --global user.email "swl@gmail.com"

        - name: Run manifest update script
          env:
            TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}

          run: |
           git clone https://soewailin:${TARGET_REPO_TOKEN}@github.com/soe-wai-lin/argo-e-commerce.git
           cd argo-e-commerce
           sed -i 's|${{ vars.IMAGE_NAME }}:.*|${{ vars.IMAGE_NAME }}:${{ github.run_id }}/g' deployment.yaml
           cat deployment.yaml
           git add .
           git commit -m "Update deployment manifest via GitHub Action"
           git push origin main
      